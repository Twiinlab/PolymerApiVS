<!DOCTYPE html>
<html>
<head>
    <link href="../../bower_components/polymer/polymer.html" rel="import">
    <link href="../../bower_components/iron-ajax/iron-ajax.html" rel="import">
</head>

<dom-module id="todo-api">

    <template>
        <!--auto-->
        <iron-ajax id="ajax"
                   handle-as="json"
                   content-type="application/json"></iron-ajax>
    </template>

</dom-module>

<script>

    var baseUrl = "http://" + window.location.hostname + ":" + window.location.port

    Polymer({
        is: 'todo-api',
        properties: {
            localList: {
                notify: true,
                type: Array,
                value: []
            }
        },
        observers: [
            'listChange(localList.*)'
        ],

        listChange: function (changeRecord) {
            if (changeRecord.path == 'localList.splices') {
                // a task was added or removed
                var _this = this;
                changeRecord.value.indexSplices.forEach(function (s) {
                    s.removed.forEach(function (item) {
                        //Delete task
                        _this.$.ajax.url = [baseUrl, "api/todo", item.rid].join('/');
                        _this.$.ajax.method = "DELETE";
                        _this.$.ajax.generateRequest();
                        console.log("id:" + item.rid + " task: " + item.task + " - by" + item.user + ' was removed');
                    });
                    if (s.addedCount > 0) {
                        //Add task
                        this.$.ajax.url = [baseUrl, "api/todo"].join('/');
                        this.$.ajax.body = JSON.stringify({ rid: s.object[s.index].rid, user: s.object[s.index].user, task: s.object[s.index].task });
                        this.$.ajax.method = "POST";
                        this.$.ajax.generateRequest();
                        console.log("id:" + s.object[s.index].rid + " task: " + s.object[s.index].task + " - by " + s.object[s.index].user + ' was added');
                    }
                }, this);

            } else {
                // an individual task or its properties changed
                if (changeRecord.value.rid != null) {
                    this.$.ajax.url = [baseUrl, "api/todo", changeRecord.value.rid].join('/');
                    this.$.ajax.body = JSON.stringify({ rid: changeRecord.value.rid, user: changeRecord.value.user, task: changeRecord.value.task });
                    this.$.ajax.method = "PUT";
                    this.$.ajax.generateRequest();
                    console.log("id:" + changeRecord.value.rid + " task: " + changeRecord.value.task + " - by " + changeRecord.value.user + ' changed');
                }
            }
        },
        ready: function (e) {
            //init list
            var _this = this;
            _this.$.ajax.url = [baseUrl, "api/todo"].join('/');
            _this.$.ajax.generateRequest().completes.then(function (request) {
                _this.localList = request.response;
            });
        }
    });

</script>
